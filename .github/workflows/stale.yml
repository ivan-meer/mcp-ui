name: 🧹 Stale Issues and PRs

on:
  schedule:
    # Запуск каждый день в 2:00 UTC (5:00 MSK)
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  stale:
    name: 🧹 Mark Stale Issues and PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: 🔍 Mark stale issues and PRs
        uses: actions/stale@v9
        with:
          # Токен для авторизации
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          
          # ===========================
          # Настройки для Issues
          # ===========================
          
          # Дни до пометки как stale
          days-before-issue-stale: 30
          
          # Дни до закрытия после пометки stale
          days-before-issue-close: 7
          
          # Сообщение при пометке issue как stale
          stale-issue-message: |
            👋 Этот issue помечен как неактивный, поскольку не было активности в течение 30 дней.
            
            **Что происходит дальше?**
            - Issue будет автоматически закрыт через 7 дней, если не будет новой активности
            - Чтобы снять метку "stale", просто оставьте комментарий
            - Если issue все еще актуален, пожалуйста, предоставьте обновленную информацию
            
            **Нужна помощь?**
            - Проверьте [документацию](https://github.com/ivan-meer/mcp-ui/blob/main/README.md)
            - Посмотрите [примеры](https://github.com/ivan-meer/mcp-ui/tree/main/examples)
            - Задайте вопрос в [Discussions](https://github.com/ivan-meer/mcp-ui/discussions)
            
            Спасибо за ваш вклад! 🙏
          
          # Сообщение при закрытии issue
          close-issue-message: |
            🔒 Этот issue был автоматически закрыт из-за отсутствия активности.
            
            **Что делать, если проблема все еще актуальна?**
            - Откройте новый issue с обновленной информацией
            - Ссылайтесь на этот закрытый issue для контекста
            - Приложите актуальные логи и примеры кода
            
            Мы всегда готовы помочь с активными проблемами! 🚀
          
          # Метка для stale issues
          stale-issue-label: 'stale'
          
          # ===========================
          # Настройки для Pull Requests
          # ===========================
          
          # Дни до пометки PR как stale
          days-before-pr-stale: 14
          
          # Дни до закрытия PR после пометки stale
          days-before-pr-close: 7
          
          # Сообщение при пометке PR как stale
          stale-pr-message: |
            👋 Этот Pull Request помечен как неактивный, поскольку не было активности в течение 14 дней.
            
            **Что происходит дальше?**
            - PR будет автоматически закрыт через 7 дней, если не будет новой активности
            - Чтобы снять метку "stale", просто оставьте комментарий или сделайте push
            - Если PR все еще актуален, пожалуйста, обновите его
            
            **Советы для продолжения работы:**
            - Проверьте, что ваша ветка актуальна с main
            - Убедитесь, что все проверки проходят
            - Ответьте на комментарии ревьюеров
            - Обновите описание PR если нужно
            
            Спасибо за ваш вклад! 🙏
          
          # Сообщение при закрытии PR
          close-pr-message: |
            🔒 Этот Pull Request был автоматически закрыт из-за отсутствия активности.
            
            **Что делать, если изменения все еще актуальны?**
            - Создайте новый PR с обновленными изменениями
            - Ссылайтесь на этот закрытый PR для истории
            - Убедитесь, что новый PR актуален с main веткой
            
            Мы ценим каждый вклад и всегда готовы помочь! 🚀
          
          # Метка для stale PRs
          stale-pr-label: 'stale'
          
          # ===========================
          # Исключения
          # ===========================
          
          # Issues с этими метками не будут помечены как stale
          exempt-issue-labels: 'pinned,security,roadmap,good first issue,help wanted,priority-high,bug-confirmed'
          
          # PRs с этими метками не будут помечены как stale
          exempt-pr-labels: 'pinned,security,roadmap,priority-high,work-in-progress,dependencies'
          
          # Не закрывать issues с этими метками даже если они stale
          exempt-all-issue-labels: 'security,critical,pinned'
          
          # Не закрывать PRs с этими метками даже если они stale
          exempt-all-pr-labels: 'security,critical,pinned'
          
          # ===========================
          # Дополнительные настройки
          # ===========================
          
          # Удалять метку stale при новой активности
          remove-stale-when-updated: true
          
          # Максимум operations за запуск (rate limiting)
          operations-per-run: 100
          
          # Сортировка (по дате создания, сначала старые)
          ascending: true
          
          # Включить отладочные логи
          debug-only: false
          
          # Включить статистику
          enable-statistics: true

  # ===========================
  # Отчет о работе
  # ===========================
  report:
    name: 📊 Stale Cleanup Report
    runs-on: ubuntu-latest
    needs: stale
    if: always()
    
    steps:
      - name: 📊 Generate report
        run: |
          echo "## 🧹 Stale Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Автоматическая очистка неактивных issues и PRs выполнена." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Настройки:**" >> $GITHUB_STEP_SUMMARY
          echo "- Issues: помечаются stale через 30 дней, закрываются через 7 дней" >> $GITHUB_STEP_SUMMARY
          echo "- PRs: помечаются stale через 14 дней, закрываются через 7 дней" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Исключения:**" >> $GITHUB_STEP_SUMMARY
          echo "- Issues с метками: security, critical, pinned, roadmap" >> $GITHUB_STEP_SUMMARY
          echo "- PRs с метками: security, critical, pinned, work-in-progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Дата выполнения: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY