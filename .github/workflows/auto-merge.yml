name: ðŸ¤– Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  # ===========================
  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ»Ð¸ÑÐ½Ð¸Ðµ
  # ===========================
  auto-merge:
    name: ðŸ¤– Auto Merge PR
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'check_suite' ||
      github.event_name == 'status'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Check PR eligibility
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ PR
            let prNumber;
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'pull_request_review') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'check_suite') {
              const prs = context.payload.check_suite.pull_requests;
              if (prs.length === 0) return;
              prNumber = prs[0].number;
            } else {
              // Ð”Ð»Ñ status events Ð¸Ñ‰ÐµÐ¼ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ PR
              const commits = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: context.payload.sha
              });
              if (commits.data.length === 0) return;
              prNumber = commits.data[0].number;
            }
            
            console.log(`Checking PR #${prNumber} for auto-merge eligibility`);
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»Ð¸ PR
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ
            const conditions = {
              notDraft: !pr.draft,
              notClosed: pr.state === 'open',
              targetMain: pr.base.ref === 'main',
              hasAutoMergeLabel: pr.labels.some(label => 
                ['auto-merge', 'dependencies', 'automated'].includes(label.name)
              ),
              authorIsDependabot: pr.user.login === 'dependabot[bot]',
              authorIsTrusted: ['ivan-meer', 'github-actions[bot]'].includes(pr.user.login)
            };
            
            console.log('PR conditions:', conditions);
            
            // PR Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð»Ñ auto-merge ÐµÑÐ»Ð¸:
            // 1. Ð­Ñ‚Ð¾ dependabot PR Ñ Ð¼ÐµÑ‚ÐºÐ¾Ð¹ dependencies
            // 2. Ð­Ñ‚Ð¾ PR Ð¾Ñ‚ Ð´Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð° Ñ Ð¼ÐµÑ‚ÐºÐ¾Ð¹ auto-merge
            // 3. Ð­Ñ‚Ð¾ automated PR
            const eligible = conditions.notDraft && 
                           conditions.notClosed && 
                           conditions.targetMain && 
                           (
                             (conditions.authorIsDependabot && conditions.hasAutoMergeLabel) ||
                             (conditions.authorIsTrusted && conditions.hasAutoMergeLabel)
                           );
            
            core.setOutput('eligible', eligible);
            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_author', pr.user.login);
            
            if (eligible) {
              console.log('âœ… PR is eligible for auto-merge');
            } else {
              console.log('âŒ PR is not eligible for auto-merge');
            }

      - name: ðŸ” Check PR status
        id: status
        if: steps.check.outputs.eligible == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = ${{ steps.check.outputs.pr_number }};
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
            const { data: checks } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: pr.head.sha,
              status: 'completed'
            });
            
            const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
              owner,
              repo,
              ref: pr.head.sha
            });
            
            // ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
            const failedChecks = checks.check_runs.filter(check => 
              check.conclusion && check.conclusion !== 'success' && check.conclusion !== 'neutral'
            );
            
            const failedStatuses = statuses.filter(status => 
              status.state === 'failure' || status.state === 'error'
            );
            
            const allChecksPassed = failedChecks.length === 0 && failedStatuses.length === 0;
            const hasRequiredChecks = checks.check_runs.length > 0 || statuses.length > 0;
            
            console.log(`Checks status for PR #${prNumber}:`);
            console.log(`- Total checks: ${checks.check_runs.length}`);
            console.log(`- Failed checks: ${failedChecks.length}`);
            console.log(`- Total statuses: ${statuses.length}`);
            console.log(`- Failed statuses: ${failedStatuses.length}`);
            console.log(`- All checks passed: ${allChecksPassed}`);
            console.log(`- Has required checks: ${hasRequiredChecks}`);
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber
            });
            
            const approvedReviews = reviews.filter(review => review.state === 'APPROVED');
            const requestedChanges = reviews.filter(review => review.state === 'CHANGES_REQUESTED');
            
            // Ð”Ð»Ñ dependabot PRs Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÐ¼ review, Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… - Ñ‚Ñ€ÐµÐ±ÑƒÐµÐ¼
            const needsReview = pr.user.login !== 'dependabot[bot]';
            const hasApproval = approvedReviews.length > 0 && requestedChanges.length === 0;
            
            console.log(`Reviews status:`);
            console.log(`- Needs review: ${needsReview}`);
            console.log(`- Approved reviews: ${approvedReviews.length}`);
            console.log(`- Requested changes: ${requestedChanges.length}`);
            console.log(`- Has approval: ${hasApproval}`);
            
            const canMerge = allChecksPassed && 
                           hasRequiredChecks && 
                           (!needsReview || hasApproval);
            
            core.setOutput('can_merge', canMerge);
            core.setOutput('checks_passed', allChecksPassed);
            core.setOutput('has_approval', hasApproval);
            core.setOutput('needs_review', needsReview);

      - name: ðŸš€ Auto merge PR
        if: |
          steps.check.outputs.eligible == 'true' && 
          steps.status.outputs.can_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = ${{ steps.check.outputs.pr_number }};
            const prTitle = '${{ steps.check.outputs.pr_title }}';
            const prAuthor = '${{ steps.check.outputs.pr_author }}';
            
            try {
              console.log(`ðŸš€ Auto-merging PR #${prNumber}: ${prTitle}`);
              
              // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ ÑÐ»Ð¸ÑÐ½Ð¸Ñ
              let mergeMethod = 'squash'; // ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
              
              // Ð”Ð»Ñ dependabot Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ squash
              if (prAuthor === 'dependabot[bot]') {
                mergeMethod = 'squash';
              }
              // Ð”Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð´Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð² Ð¼Ð¾Ð¶ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ merge
              else if (prTitle.startsWith('feat:') || prTitle.startsWith('fix:')) {
                mergeMethod = 'squash';
              }
              
              const result = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: prNumber,
                merge_method: mergeMethod,
                commit_title: `${prTitle} (#${prNumber})`,
                commit_message: `Automatically merged by GitHub Actions\n\nAuthor: ${prAuthor}\nMerge method: ${mergeMethod}`
              });
              
              if (result.data.merged) {
                console.log('âœ… PR successfully merged');
                
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð¾ successful merge
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `ðŸ¤– **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ»Ð¸ÑÐ½Ð¸Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾**\n\nâœ… PR Ð±Ñ‹Ð» Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½ Ñ main Ð²ÐµÑ‚ÐºÐ¾Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¾Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº.\n\n**Ð”ÐµÑ‚Ð°Ð»Ð¸:**\n- ÐœÐµÑ‚Ð¾Ð´ ÑÐ»Ð¸ÑÐ½Ð¸Ñ: \`${mergeMethod}\`\n- Commit SHA: \`${result.data.sha}\`\n- Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾: GitHub Actions\n\nÐ¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð²Ð°Ñˆ Ð²ÐºÐ»Ð°Ð´! ðŸ™`
                });
                
              } else {
                console.log('âŒ Failed to merge PR');
                core.setFailed('Failed to merge PR');
              }
              
            } catch (error) {
              console.log('âŒ Error during auto-merge:', error.message);
              
              // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `ðŸ¤– **ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ»Ð¸ÑÐ½Ð¸Ñ**\n\nâŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ PR.\n\n**ÐžÑˆÐ¸Ð±ÐºÐ°:** ${error.message}\n\n**Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ:**\n- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²\n- Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸\n- ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ\n\n**ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ:** Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ð½Ðµ Ñ€ÐµÑˆÐ°ÐµÑ‚ÑÑ, ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ issue Ñ Ð´ÐµÑ‚Ð°Ð»ÑÐ¼Ð¸.`
              });
              
              core.setFailed(`Auto-merge failed: ${error.message}`);
            }

      - name: ðŸ“Š Log auto-merge attempt
        if: always() && steps.check.outputs.eligible == 'true'
        run: |
          echo "## ðŸ¤– Auto-Merge Attempt Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- Number: #${{ steps.check.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Title: ${{ steps.check.outputs.pr_title }}" >> $GITHUB_STEP_SUMMARY
          echo "- Author: ${{ steps.check.outputs.pr_author }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:**" >> $GITHUB_STEP_SUMMARY
          echo "- Eligible: ${{ steps.check.outputs.eligible }}" >> $GITHUB_STEP_SUMMARY
          echo "- Checks passed: ${{ steps.status.outputs.checks_passed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Has approval: ${{ steps.status.outputs.has_approval }}" >> $GITHUB_STEP_SUMMARY
          echo "- Needs review: ${{ steps.status.outputs.needs_review }}" >> $GITHUB_STEP_SUMMARY
          echo "- Can merge: ${{ steps.status.outputs.can_merge }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY