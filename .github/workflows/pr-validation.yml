name: ğŸ” PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '10'

jobs:
  # ===========================
  # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ PR
  # ===========================
  validate-pr:
    name: ğŸ” PR Basic Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          scopes: |
            client
            server
            shared
            examples
            docs
            deps
            release
          requireScope: false
          disallowScopes: |
            release
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: ğŸ“Š Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);
            const totalFiles = files.length;
            
            console.log(`ğŸ“Š PR Statistics:`);
            console.log(`- Files changed: ${totalFiles}`);
            console.log(`- Total changes: ${totalChanges}`);
            
            // ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… PR
            if (totalChanges > 1000) {
              core.warning(`ğŸš¨ Large PR detected: ${totalChanges} changes across ${totalFiles} files. Consider splitting into smaller PRs for easier review.`);
            }
            
            if (totalFiles > 50) {
              core.warning(`ğŸš¨ Many files changed: ${totalFiles} files. Consider splitting into smaller PRs.`);
            }

      - name: ğŸ” Check for breaking changes
        run: |
          echo "ğŸ” Checking for potential breaking changes..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² API Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…
          if git diff --name-only origin/main...HEAD | grep -E "(packages/.*/src/.*\.ts|packages/.*/index\.ts)" | head -5; then
            echo "âš ï¸ API files changed - please ensure backwards compatibility"
            echo "ğŸ“ Consider updating CHANGELOG.md if this includes breaking changes"
          else
            echo "âœ… No API files changed"
          fi

  # ===========================
  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ PR
  # ===========================
  test-pr:
    name: ğŸ§ª Test PR Changes
    runs-on: ubuntu-latest
    needs: validate-pr
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” ESLint check
        run: pnpm lint

      - name: ğŸ¨ Format check
        run: pnpm format --check

      - name: ğŸ”¨ Build check
        run: pnpm build

      - name: ğŸ§ª Run tests
        run: pnpm test

      - name: ğŸ“Š Generate coverage
        run: pnpm coverage
        continue-on-error: true

      - name: ğŸ“Š Comment coverage report
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            
            try {
              const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              
              const comment = `## ğŸ“Š Coverage Report
              
              | Metric | Percentage | Covered/Total |
              |--------|-----------|---------------|
              | Lines | ${total.lines.pct}% | ${total.lines.covered}/${total.lines.total} |
              | Functions | ${total.functions.pct}% | ${total.functions.covered}/${total.functions.total} |
              | Branches | ${total.branches.pct}% | ${total.branches.covered}/${total.branches.total} |
              | Statements | ${total.statements.pct}% | ${total.statements.covered}/${total.statements.total} |
              
              ${total.lines.pct >= 80 ? 'âœ…' : 'âš ï¸'} Overall coverage: **${total.lines.pct}%**
              `;
              
              // ĞĞ°Ğ¹Ñ‚Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Coverage Report')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Coverage report not available:', error.message);
            }

  # ===========================
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¾Ğ²
  # ===========================
  test-examples-pr:
    name: ğŸ¯ Test Examples with PR Changes
    runs-on: ubuntu-latest
    needs: validate-pr
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build packages
        run: pnpm build

      - name: ğŸ¯ Test demo script
        run: |
          chmod +x ./start-demo.sh
          timeout 30s ./start-demo.sh --static --no-browser || [ $? -eq 124 ]

      - name: ğŸ¯ Test examples server build
        run: |
          cd examples/server
          pnpm install --frozen-lockfile
          pnpm typecheck || echo "âš ï¸ Typecheck issues found"
          pnpm build || echo "âš ï¸ Build issues found"

  # ===========================
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
  # ===========================
  compatibility-check:
    name: ğŸ”§ Compatibility Check
    runs-on: ${{ matrix.os }}
    needs: validate-pr
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node: ['18', '20']
        
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build packages
        run: pnpm build

      - name: ğŸ§ª Run tests
        run: pnpm test

  # ===========================
  # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
  # ===========================
  auto-checks:
    name: ğŸ¤– Automated Checks
    runs-on: ubuntu-latest
    needs: [test-pr, test-examples-pr]
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for security issues
        run: |
          echo "ğŸ”’ Checking for potential security issues..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ² ĞºĞ¾Ğ´Ğµ
          if git diff --name-only origin/main...HEAD | xargs grep -l -i "password\|secret\|token\|key" || true; then
            echo "âš ï¸ Files contain potential secrets - please review"
          else
            echo "âœ… No obvious secrets found"
          fi

      - name: ğŸ“ Check CHANGELOG update
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const hasFeatureChanges = files.some(file => 
              file.filename.startsWith('packages/') && 
              (file.status === 'added' || file.status === 'modified')
            );
            
            const hasChangelogUpdate = files.some(file => 
              file.filename === 'CHANGELOG.md'
            );
            
            if (hasFeatureChanges && !hasChangelogUpdate) {
              console.log('âš ï¸ Consider updating CHANGELOG.md for user-facing changes');
            } else {
              console.log('âœ… CHANGELOG update check passed');
            }

  # ===========================
  # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
  # ===========================
  pr-status:
    name: ğŸ“Š PR Status Summary
    runs-on: ubuntu-latest
    needs: [validate-pr, test-pr, test-examples-pr, compatibility-check, auto-checks]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate status summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Validation', result: '${{ needs.validate-pr.result }}' },
              { name: 'Tests', result: '${{ needs.test-pr.result }}' },
              { name: 'Examples', result: '${{ needs.test-examples-pr.result }}' },
              { name: 'Compatibility', result: '${{ needs.compatibility-check.result }}' },
              { name: 'Auto Checks', result: '${{ needs.auto-checks.result }}' }
            ];
            
            const passed = jobs.filter(job => job.result === 'success').length;
            const total = jobs.length;
            
            const summary = jobs.map(job => {
              const emoji = job.result === 'success' ? 'âœ…' : job.result === 'failure' ? 'âŒ' : 'âš ï¸';
              return `${emoji} ${job.name}`;
            }).join('\n');
            
            const comment = `## ğŸ“Š PR Validation Summary
            
            **Status: ${passed}/${total} checks passed**
            
            ${summary}
            
            ${passed === total ? 'ğŸ‰ All checks passed! This PR is ready for review.' : 'âš ï¸ Some checks failed. Please review and fix issues.'}
            `;
            
            console.log(comment);
            
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            if (passed === total) {
              core.notice('ğŸ‰ All PR validation checks passed!');
            } else {
              core.setFailed(`âŒ ${total - passed} validation checks failed`);
            }